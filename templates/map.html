<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Hotspots Map - {{ station }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .info-panel h3 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
        }

        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stat-box h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-box .value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }

        .pattern-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .pattern-analysis h4 {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 14px;
        }

        .pattern-analysis ul {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
            color: #856404;
        }

        .pattern-analysis li {
            margin-bottom: 5px;
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
        }

        .leaflet-popup-content strong {
            color: #1976d2;
            font-size: 15px;
            display: block;
            margin-bottom: 10px;
        }

        .popup-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .popup-stat:last-child {
            border-bottom: none;
        }

        .popup-label {
            color: #666;
            font-weight: 500;
        }

        .popup-value {
            color: #333;
            font-weight: bold;
        }

        .heatmap-toggle {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            font-weight: 600;
            transition: all 0.3s;
        }

        .heatmap-toggle:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .cluster-icon {
            background: rgba(220, 53, 69, 0.8);
            border-radius: 50%;
            text-align: center;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .info-panel {
                max-width: 280px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>üó∫Ô∏è {{ station }} Hotspots</h3>

        <div class="stat-box">
            <h4>Total Hotspots</h4>
            <p class="value">{{ hotspots|length }}</p>
        </div>

        <div class="legend">
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Risk Levels</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #d32f2f;"></div>
                <span><strong>Critical:</strong> 10+ incidents</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f57c00;"></div>
                <span><strong>High:</strong> 5-9 incidents</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fbc02d;"></div>
                <span><strong>Medium:</strong> 3-4 incidents</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1976d2;"></div>
                <span><strong>Low:</strong> 1-2 incidents</span>
            </div>
        </div>

        <div class="pattern-analysis" id="patternAnalysis">
            <h4>üìä Pattern Analysis</h4>
            <ul id="patternList">
                <li>Analyzing crime patterns...</li>
            </ul>
        </div>
    </div>

    <div class="heatmap-toggle" onclick="toggleClusters()" id="toggleBtn">
        üî• Toggle Clusters
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([{{ center_lat }}, {{ center_lon }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        const hotspots = {{ hotspots_json|safe }};

        // Create marker cluster group
        const markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let size = 40;
                let className = 'cluster-icon';

                if (count > 20) {
                    size = 60;
                } else if (count > 10) {
                    size = 50;
                }

                return L.divIcon({
                    html: `<div class="cluster-icon" style="width:${size}px;height:${size}px;line-height:${size}px;">${count}</div>`,
                    className: '',
                    iconSize: [size, size]
                });
            },
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        let regularMarkers = [];
        let clustersEnabled = true;

        // Analyze patterns
        function analyzePatterns() {
            const patterns = [];

            // Find highest risk areas
            const critical = hotspots.filter(h => h.incident_count >= 10);
            if (critical.length > 0) {
                const topArea = critical.sort((a, b) => b.incident_count - a.incident_count)[0];
                patterns.push(`<strong>Highest Risk:</strong> ${topArea.location} (${topArea.incident_count} incidents)`);
            }

            // Calculate average incidents
            const avgIncidents = (hotspots.reduce((sum, h) => sum + h.incident_count, 0) / hotspots.length).toFixed(1);
            patterns.push(`<strong>Average:</strong> ${avgIncidents} incidents per location`);

            // Risk distribution
            const criticalCount = hotspots.filter(h => h.incident_count >= 10).length;
            const highCount = hotspots.filter(h => h.incident_count >= 5 && h.incident_count < 10).length;
            const mediumCount = hotspots.filter(h => h.incident_count >= 3 && h.incident_count < 5).length;

            if (criticalCount > 0) {
                patterns.push(`<strong>${criticalCount}</strong> critical risk zones identified`);
            }
            if (highCount > 0) {
                patterns.push(`<strong>${highCount}</strong> high risk areas detected`);
            }

            // Recent activity
            const recentIncidents = hotspots.filter(h => {
                const lastDate = new Date(h.last_incident);
                const daysSince = (Date.now() - lastDate) / (1000 * 60 * 60 * 24);
                return daysSince <= 7;
            }).length;

            if (recentIncidents > 0) {
                patterns.push(`<strong>${recentIncidents}</strong> locations with incidents in last 7 days`);
            }

            // Concentration analysis
            const totalIncidents = hotspots.reduce((sum, h) => sum + h.incident_count, 0);
            const top3 = hotspots.sort((a, b) => b.incident_count - a.incident_count).slice(0, 3);
            const top3Total = top3.reduce((sum, h) => sum + h.incident_count, 0);
            const concentration = ((top3Total / totalIncidents) * 100).toFixed(0);

            patterns.push(`<strong>${concentration}%</strong> of incidents in top 3 locations`);

            return patterns;
        }

        // Display patterns
        const patterns = analyzePatterns();
        const patternList = document.getElementById('patternList');
        patternList.innerHTML = patterns.map(p => `<li>${p}</li>`).join('');

        // Create markers
        hotspots.forEach(hotspot => {
            const lat = hotspot.lat;
            const lon = hotspot.lon;
            const count = hotspot.incident_count;

            let color, radius, riskLevel;
            if (count >= 10) {
                color = '#d32f2f';
                radius = 18;
                riskLevel = 'CRITICAL';
            } else if (count >= 5) {
                color = '#f57c00';
                radius = 15;
                riskLevel = 'HIGH';
            } else if (count >= 3) {
                color = '#fbc02d';
                radius = 12;
                riskLevel = 'MEDIUM';
            } else {
                color = '#1976d2';
                radius = 10;
                riskLevel = 'LOW';
            }

            const circle = L.circleMarker([lat, lon], {
                radius: radius,
                fillColor: color,
                color: '#fff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            });

            const popupContent = `
                <strong>${hotspot.location}</strong>
                <div style="margin-top: 10px;">
                    <div class="popup-stat">
                        <span class="popup-label">Risk Level:</span>
                        <span class="popup-value" style="color: ${color};">${riskLevel}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-label">Incidents:</span>
                        <span class="popup-value">${count}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-label">Last Incident:</span>
                        <span class="popup-value">${hotspot.last_incident ? new Date(hotspot.last_incident).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
            `;

            circle.bindPopup(popupContent);

            markers.addLayer(circle);
            regularMarkers.push(circle);
        });

        // Add markers to map
        map.addLayer(markers);

        // Toggle clusters function
        function toggleClusters() {
            const btn = document.getElementById('toggleBtn');

            if (clustersEnabled) {
                map.removeLayer(markers);
                regularMarkers.forEach(marker => marker.addTo(map));
                btn.textContent = 'üìç Toggle Clusters';
                btn.style.background = '#4caf50';
                btn.style.color = 'white';
                clustersEnabled = false;
            } else {
                regularMarkers.forEach(marker => map.removeLayer(marker));
                map.addLayer(markers);
                btn.textContent = 'üî• Toggle Clusters';
                btn.style.background = 'white';
                btn.style.color = '#333';
                clustersEnabled = true;
            }
        }

        // Auto-fit bounds if hotspots exist
        if (hotspots.length > 0) {
            const bounds = L.latLngBounds(hotspots.map(h => [h.lat, h.lon]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    </script>
</body>
</html>